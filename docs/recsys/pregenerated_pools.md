# Импорт предсгенерированных вариантов

Этот документ описывает полный цикл работы с пулами предсгенерированных вариантов заданий: от подготовки файлов до импорта через management-команду и административный интерфейс.

## Подготовка входных файлов

Система поддерживает два формата входных данных: CSV и JSON. В обоих случаях каждая запись должна описывать один вариант для конкретного задания (`Task`).

### CSV

* Файл должен содержать заголовок и столбцы `parameter_values`, `correct_answer`, `meta`, `is_active`.
* `parameter_values`, `correct_answer` и `meta` — JSON-объекты, закодированные строкой.
* `is_active` — булево значение; допустимы `1`, `0`, `true`, `false`, `yes`, `no`, `да`, `нет` (без учёта регистра). Если поле пустое, считается `true`.

```csv
parameter_values,correct_answer,meta,is_active
"{\"question\": \"2 + 2\", \"choices\": [3, 4, 5]}","{\"value\": 4}","{\"difficulty\": \"base\"}",true
"{\"question\": \"3 + 5\"}","{\"value\": 8}","{}",false
```

### JSON

* Структура файла — список объектов.
* Каждый объект может содержать ключи `parameter_values`, `correct_answer`, `meta`, `is_active`.
* Поля `parameter_values`, `correct_answer`, `meta` должны быть JSON-объектами; поле можно опустить или оставить пустым объектом `{}`.

```json
[
  {
    "parameter_values": {"question": "2 + 2", "choices": [3, 4, 5]},
    "correct_answer": {"value": 4},
    "meta": {"difficulty": "base"},
    "is_active": true
  },
  {
    "parameter_values": {"question": "3 + 5"},
    "correct_answer": {"value": 8}
  }
]
```

## Импорт через management-команду

Для загрузки файла используйте команду `import_pregenerated_pool`:

```bash
python manage.py import_pregenerated_pool \
    --task-id=42 \
    --format=csv \
    --path=/path/to/pregenerated_pool.csv
```

Аргументы:

* `--task-id` — идентификатор задания (`Task.pk`), к которому относится пул вариантов.
* `--format` — формат входного файла (`csv` или `json`).
* `--path` — путь к файлу.

При успешном выполнении команда выводит сводку, например:

```
Processed 10 row(s); created 10 dataset(s) for task 42.
```

### Отчёт об ошибках

Если при разборе отдельных строк возникают ошибки валидации, команда завершится успешно, но сообщит об ошибках:

```
Processed 5 row(s); created 4 dataset(s) for task 42.
Encountered 1 parsing error(s):
- Строка 3: Поле 'parameter_values' должно быть JSON-объектом
```

Ошибки формируются по шаблону `Строка N: <описание>` — их удобно использовать при исправлении исходного файла.

## Импорт через административный интерфейс

1. Зайдите в Django Admin и откройте раздел «Задания» (`Task`).
2. Нажмите действие «Импорт предсгенерированных вариантов» в правом верхнем углу или перейдите по ссылке `/admin/recsys/task/pregenerated-upload/`.
3. Выберите задание, формат файла и загрузите файл.
4. После отправки формы система покажет статус импорта и сообщения об ошибках по тем же шаблонам, что и management-команда.

Успешно загруженные варианты можно посмотреть в списке «Список предсгенерированных вариантов» из карточки задания или по адресу `/admin/recsys/taskpregenerateddataset/` с фильтром по нужному заданию.

## Рекомендации по отладке

* Перед массовой загрузкой импортируйте небольшой файл (1–2 строки), чтобы убедиться, что формат распознан корректно.
* Для CSV-файлов убедитесь, что файл сохранён в UTF-8 и значения JSON экранированы.
* Отключённые (`is_active = false`) варианты остаются в базе, но не участвуют в выборе — это удобно для постепенного ввода контента.
