{% extends 'base.html' %}
{% load i18n markdown_extras %}

{% block title %}{{ module.title }} — {{ course.title }}{% endblock %}

{% block content %}
  <div class="container module-detail">
    <nav class="module-detail__breadcrumbs" aria-label="{% trans 'Навигация по курсу' %}">
      <a class="module-detail__breadcrumb" href="{% url 'accounts:dashboard-courses' %}">{% trans 'Курсы' %}</a>
      <span aria-hidden="true">/</span>
      <a class="module-detail__breadcrumb" href="{% url 'accounts:dashboard-courses' %}?course={{ course.slug }}">{{ course.title }}</a>
      <span aria-hidden="true">/</span>
      <span class="module-detail__breadcrumb module-detail__breadcrumb--current">{{ module.title }}</span>
    </nav>

    <div class="module-detail__layout">
      <details class="module-detail__accordion">
        <summary class="module-detail__accordion-summary">
          <span class="module-detail__title module-detail__accordion-title" role="heading" aria-level="2">{{ module.title }}</span>
        </summary>

        <div class="module-detail__accordion-body">
          <header class="module-detail__header">
            <h2 class="module-detail__title sr-only">{{ module.title }}</h2>
            {% if module.subtitle %}
              <p class="module-detail__subtitle">{{ module.subtitle }}</p>
            {% endif %}
            <dl class="module-detail__stats">
              <div>
                <dt>{% trans 'Освоение модуля' %}</dt>
                <dd>{{ module_mastery_percent|floatformat:'-1' }}%</dd>
              </div>
              <div>
                <dt>{% trans 'Количество элементов' %}</dt>
                <dd>{{ items|length }}</dd>
              </div>
            </dl>
          </header>

          {% if module.description %}
            <div class="module-detail__description">{{ module.description|linebreaks }}</div>
          {% endif %}

          {% if incoming_edges or outgoing_edges %}
            <section class="module-detail__relations" aria-label="{% trans 'Связи модуля' %}">
              {% if incoming_edges %}
                <div>
                  <h3>{% trans 'Требует перед собой' %}</h3>
                  <ul>
                    {% for edge in incoming_edges %}
                      <li>{{ edge.src.title }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
              {% if outgoing_edges %}
                <div>
                  <h3>{% trans 'Открывает после прохождения' %}</h3>
                  <ul>
                    {% for edge in outgoing_edges %}
                      <li>{{ edge.dst.title }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}
            </section>
          {% endif %}
        </div>
      </details>

      <section class="module-detail__items-switcher" aria-label="{% trans 'Навигация по карточкам модуля' %}">
        <h3 class="module-detail__items-switcher-title">{% trans 'Карточки модуля' %}</h3>
        {% if items_with_state %}
          <div class="module-detail__items-buttons">
            {% for entry in items_with_state %}
              {% with item=entry.item %}
                {% if entry.is_visible %}
                  <a
                    href="?item={{ item.id }}"
                    class="module-detail__item-button module-detail__item-button--{{ entry.status }}{% if entry.is_current %} module-detail__item-button--current{% endif %}"
                    role="button"
                    {% if entry.is_current %}aria-current="page"{% endif %}
                  >
                {% else %}
                  <span
                    class="module-detail__item-button module-detail__item-button--{{ entry.status }} module-detail__item-button--locked{% if entry.is_current %} module-detail__item-button--current{% endif %}"
                    aria-disabled="true"
                  >
                {% endif %}
                    <span class="module-detail__item-button-index">{{ entry.position }}</span>
                    <span class="module-detail__item-button-title">
                      {% if item.theory_card %}
                        {{ item.theory_card.title }}
                      {% elif item.task %}
                        {{ item.task.title|default:item.task.pk }}
                      {% else %}
                        #{{ item.pk }}
                      {% endif %}
                    </span>
                  {% if entry.is_visible %}
                  </a>
                  {% else %}
                  </span>
                  {% endif %}
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">{% trans 'В модуле пока нет элементов.' %}</p>
        {% endif %}
      </section>

      <section class="module-detail__content" aria-live="polite">
        {% if current_item %}
          {% if not current_item_accessible %}
            <div class="module-detail__alert module-detail__alert--warning">
              {% blocktrans %}Текущий элемент недоступен при уровне освоения {{ module_mastery_percent|floatformat:'-1' }}%.{% endblocktrans %}
              </div>
          {% endif %}

          <article class="module-detail__card" data-kind="{% if current_item.kind == current_item.ItemKind.THEORY %}theory{% elif current_item.kind == current_item.ItemKind.TASK %}task{% else %}generic{% endif %}">
            <header class="module-detail__card-header">
              <h3 class="module-detail__card-title">
                {% if current_item.kind == current_item.ItemKind.THEORY and current_item.theory_card %}
                  {{ current_item.theory_card.title }}
                {% elif current_item.kind == current_item.ItemKind.TASK and current_item.task %}
                  {{ current_item.task.title|default:current_item.task.pk }}
                {% else %}
                  {% trans 'Элемент модуля' %}
                {% endif %}
              </h3>
              <p class="module-detail__card-meta">
                {% if current_item.kind == current_item.ItemKind.THEORY %}
                  {% trans 'Карточка теории' %}
                {% elif current_item.kind == current_item.ItemKind.TASK %}
                  {% trans 'Практическое задание' %}
                {% endif %}
              </p>
            </header>

            <div class="module-detail__card-body">
              {% if current_item.kind == current_item.ItemKind.THEORY and current_item.theory_card %}
                {% if current_item.theory_card.content_format == current_item.theory_card.ContentFormat.HTML %}
                  <div class="module-detail__theory" data-format="html">
                    {{ current_item.theory_card.content|safe }}
                  </div>
                {% elif current_item.theory_card.content_format == current_item.theory_card.ContentFormat.MARKDOWN %}
                  <div class="module-detail__theory markdown-content" data-format="markdown">
                    {{ current_item.theory_card.content|render_markdown }}
                  </div>
                {% else %}
                  <div class="module-detail__theory" data-format="text">
                    {{ current_item.theory_card.content|linebreaks }}
                  </div>
                {% endif %}
              {% elif current_item.kind == current_item.ItemKind.TASK and current_item.task %}
                <div class="module-detail__task">
                  <dl class="module-detail__task-meta module-detail__task-meta--top">
                    {% if current_item.task.type %}
                      <div>
                        <dt>{% trans 'Тип задания' %}</dt>
                        <dd>{{ current_item.task.type.name }}</dd>
                      </div>
                    {% endif %}
                    {% if current_item.task.subject %}
                      <div>
                        <dt>{% trans 'Предмет' %}</dt>
                        <dd>{{ current_item.task.subject.name }}</dd>
                      </div>
                    {% endif %}
                  </dl>
                  <div class="module-detail__task-panel">
                    <div class="module-detail__task-statement">
                      {% with display=current_task_display %}
                        {% if display and display.description %}
                          {% if display.rendering_strategy == current_item.task.RenderingStrategy.HTML %}
                            <div class="module-detail__task-description task-content" data-format="html">
                              {{ display.description|render_task_body:display.rendering_strategy }}
                            </div>
                          {% elif display.rendering_strategy == current_item.task.RenderingStrategy.MARKDOWN %}
                            <div class="module-detail__task-description markdown-content task-content" data-format="markdown">
                              {{ display.description|render_task_body:display.rendering_strategy }}
                            </div>
                          {% else %}
                            <div class="module-detail__task-description task-content" data-format="text">
                              {{ display.description|render_task_body:display.rendering_strategy }}
                            </div>
                          {% endif %}
                        {% elif current_item.task.description %}
                          {% if current_item.task.rendering_strategy == current_item.task.RenderingStrategy.HTML %}
                            <div class="module-detail__task-description task-content" data-format="html">
                              {{ current_item.task.description|render_task_body:current_item.task.rendering_strategy }}
                            </div>
                          {% elif current_item.task.rendering_strategy == current_item.task.RenderingStrategy.MARKDOWN %}
                            <div class="module-detail__task-description markdown-content task-content" data-format="markdown">
                              {{ current_item.task.description|render_task_body:current_item.task.rendering_strategy }}
                            </div>
                          {% else %}
                            <div class="module-detail__task-description task-content" data-format="text">
                              {{ current_item.task.description|render_task_body:current_item.task.rendering_strategy }}
                            </div>
                          {% endif %}
                        {% else %}
                          <p class="muted">{% trans 'Описание задания пока отсутствует.' %}</p>
                        {% endif %}
                        {% if display and display.image %}
                          <div class="module-detail__task-image">
                            <img src="{{ display.image }}" alt="{% trans 'Иллюстрация к заданию' %}">
                          </div>
                        {% endif %}
                      {% endwith %}
                    </div>
                    {% with form=task_answer_form %}
                      {% if form and form.is_available %}
                        <form method="post" class="module-detail__task-form">
                          {% csrf_token %}
                          <input type="hidden" name="item_id" value="{{ current_item.id }}">
                          <input type="hidden" name="action" value="submit-answer">
                          <fieldset class="module-detail__answer-fields">
                            <legend class="sr-only">{{ task_answer_legend }}</legend>
                            {% if form.non_field_errors %}
                              <ul class="errorlist">
                                {% for error in form.non_field_errors %}
                                  <li>{{ error }}</li>
                                {% endfor %}
                              </ul>
                            {% endif %}
                            {% for field in form %}
                              <div class="module-detail__answer-field">
                                {{ field }}
                                {% if field.errors %}
                                  <ul class="errorlist">
                                    {% for error in field.errors %}
                                      <li>{{ error }}</li>
                                    {% endfor %}
                                  </ul>
                                {% endif %}
                              </div>
                            {% endfor %}
                          </fieldset>
                          <div class="module-detail__action-buttons module-detail__action-buttons--inline">
                            <button type="submit" class="btn btn--primary">
                              {{ task_answer_submit_label }}
                            </button>
                          </div>
                        </form>
                      {% else %}
                        <p class="muted module-detail__task-form-placeholder">{{ task_answer_unavailable_message }}</p>
                      {% endif %}
                    {% endwith %}
                  </div>
                </div>
              {% else %}
                <p class="muted">{% trans 'Контент для этого элемента пока недоступен.' %}</p>
              {% endif %}
            </div>

            <footer class="module-detail__card-footer">
              {% if current_item.kind == current_item.ItemKind.THEORY %}
                <form method="post" class="module-detail__action-form">
                  {% csrf_token %}
                  <input type="hidden" name="item_id" value="{{ current_item.id }}">
                  <div class="module-detail__action-buttons">
                    <button type="submit" name="action" value="success" class="btn btn--success">
                      {% trans 'Отметить карточку как пройденную' %}
                    </button>
                    <button type="submit" name="action" value="failure" class="btn btn--secondary">
                      {% trans 'Нужна повторная попытка' %}
                    </button>
                  </div>
                </form>
              {% endif %}
              <nav class="module-detail__card-navigation" aria-label="{% trans 'Навигация по элементам модуля' %}">
                {% if previous_item %}
                  <a class="module-detail__nav-link" href="?item={{ previous_item.id }}">{% trans '← Предыдущий доступный элемент' %}</a>
                {% endif %}
                {% if next_item %}
                  <a class="module-detail__nav-link" href="?item={{ next_item.id }}">{% trans 'Следующий доступный элемент →' %}</a>
                {% endif %}
              </nav>
              {% if is_last_module_item %}
                <a class="btn" href="{% url 'accounts:dashboard-courses' %}">{% trans 'Вернуться к курсам' %}</a>
              {% endif %}
            </footer>
          </article>
        {% else %}
          <p class="muted">{% trans 'Доступные элементы не найдены. Попробуйте позже.' %}</p>
        {% endif %}
      </section>
    </div>
  </div>
{% endblock %}
