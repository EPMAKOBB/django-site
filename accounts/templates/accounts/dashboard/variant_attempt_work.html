{% extends 'accounts/dashboard/base.html' %}
{% load i18n markdown_extras %}

{% block dashboard_title %}{{ assignment.template.name }}{% endblock %}

{% block dashboard_content %}
  <section class="card attempt-work">
    <header class="attempt-work__header">
      <h2 class="attempt-work__title">{{ assignment.template.name }}</h2>
      <div class="attempt-work__meta">
        <div>
          <span class="attempt-work__label">{% trans "Попытка" %}</span>
          <span class="attempt-work__value">#{{ attempt.attempt_number }}</span>
        </div>
        <div>
          <span class="attempt-work__label">{% trans "Прогресс" %}</span>
          <span class="attempt-work__value">
            {% blocktrans with solved=progress_summary.solved_tasks total=progress_summary.total_tasks %}
              {{ solved }} из {{ total }} задач
            {% endblocktrans %}
          </span>
        </div>
        {% if assignment.deadline %}
          <div>
            <span class="attempt-work__label">{% trans "Дедлайн" %}</span>
            <span class="attempt-work__value">{{ assignment.deadline|date:"d E Y H:i" }}</span>
          </div>
        {% endif %}
        {% if time_left %}
          <div>
            <span class="attempt-work__label">{% trans "Оставшееся время" %}</span>
            <span class="attempt-work__value">{{ time_left }}</span>
          </div>
        {% endif %}
        <div>
          <span class="attempt-work__label">{% trans "Статус" %}</span>
          {% if attempt_completed %}
            <span class="attempt-work__badge attempt-work__badge--success">{% trans "Завершено" %}</span>
          {% else %}
            <span class="attempt-work__badge attempt-work__badge--active">{% trans "В процессе" %}</span>
          {% endif %}
        </div>
      </div>
    </header>

    {% if not attempt_completed %}
      <div class="attempt-work__actions">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="finalize">
          <button type="submit" class="btn btn-primary">
            {% if all_completed %}
              {% trans "Завершить попытку" %}
            {% else %}
              {% trans "Завершить попытку (даже если остались задачи)" %}
            {% endif %}
          </button>
        </form>
      </div>
      {% if not all_completed %}
        <p class="attempt-work__hint">{% trans "Вы можете завершить попытку в любой момент. После завершения изменить ответы будет нельзя." %}</p>
      {% endif %}
    {% else %}
      <p class="attempt-work__hint attempt-work__hint--muted">{% trans "Попытка закрыта: ответы сохранены, новые попытки недоступны." %}</p>
    {% endif %}
  </section>

  {% for item in tasks %}
    <article class="card attempt-task" id="variant-task-{{ item.variant_task.id }}">
      <header class="attempt-task__header">
        <div class="attempt-task__heading">
          <span class="attempt-task__index">#{{ item.order }}</span>
          <h3 class="attempt-task__title">{{ item.display.title }}</h3>
        </div>
        <div class="attempt-task__badges">
          <span class="attempt-task__badge">{% if item.task.type %}{{ item.task.type.name }}{% endif %}</span>
          {% if item.task.subject %}
            <span class="attempt-task__badge">{{ item.task.subject.name }}</span>
          {% endif %}
          <span class="attempt-task__badge">{% blocktrans with diff=item.task.difficulty_level %}Сложность {{ diff }}{% endblocktrans %}</span>
          {% if item.is_completed %}
            <span class="attempt-task__badge attempt-task__badge--success">{% trans "Решена" %}</span>
          {% elif item.remaining_attempts == 0 and item.max_attempts %}
            <span class="attempt-task__badge attempt-task__badge--danger">{% trans "Лимит попыток" %}</span>
          {% endif %}
        </div>
      </header>

      <div class="attempt-task__body">
        {% if item.display.description %}
          {% if item.display.rendering_strategy == 'html' %}
            <div class="attempt-task__statement" data-format="html">{{ item.display.description|safe }}</div>
          {% elif item.display.rendering_strategy == 'markdown' %}
            <div class="attempt-task__statement" data-format="markdown">{{ item.display.description|render_markdown }}</div>
          {% else %}
            <p class="attempt-task__statement" data-format="text">{{ item.display.description|linebreaksbr }}</p>
          {% endif %}
        {% endif %}

        {% if item.display.image %}
          <figure class="attempt-task__figure">
            <img src="{{ item.display.image }}" alt="{% trans 'Иллюстрация к задаче' %}">
          </figure>
        {% endif %}

        {% if item.skills %}
          <div class="attempt-task__skills">
            <span class="attempt-task__skills-label">{% trans "Навыки" %}:</span>
            <ul class="attempt-task__skills-list">
              {% for skill in item.skills %}
                <li>{{ skill.name }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}
      </div>

      {% if item.history %}
        <section class="attempt-task__history" aria-label="{% trans 'История попыток по задаче' %}">
          <h4>{% trans "История попыток" %}</h4>
          <ul>
            {% for entry in item.history %}
              <li>
                <span class="attempt-task__history-number">#{% firstof entry.number %}</span>
                {% if entry.is_correct %}
                  <span class="attempt-task__history-status attempt-task__history-status--success">{% trans "верно" %}</span>
                {% else %}
                  <span class="attempt-task__history-status attempt-task__history-status--muted">{% trans "повторить" %}</span>
                {% endif %}
                <time datetime="{{ entry.created_at|date:'c' }}">{{ entry.created_at|date:"d.m.Y H:i" }}</time>
                {% if entry.response_text %}
                  <pre class="attempt-task__history-answer">{{ entry.response_text }}</pre>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </section>
      {% endif %}

      {% if not attempt_completed %}
        {% if item.is_completed %}
          <p class="attempt-task__hint attempt-task__hint--success">{% trans "Задача уже решена в этой попытке." %}</p>
        {% elif item.remaining_attempts == 0 and item.max_attempts %}
          <p class="attempt-task__hint attempt-task__hint--danger">{% trans "Лимит попыток исчерпан." %}</p>
        {% else %}
          <form method="post" class="attempt-task__form">
            {% csrf_token %}
            <input type="hidden" name="action" value="submit-task">
            <input type="hidden" name="variant_task_id" value="{{ item.variant_task.id }}">
            <label class="attempt-task__label" for="response-{{ item.variant_task.id }}">{% trans "Ваше решение или заметки" %}</label>
            <textarea id="response-{{ item.variant_task.id }}" name="response" rows="4" placeholder="{% trans 'Опишите ход решения или оставьте заметку для себя' %}"></textarea>
            <div class="attempt-task__form-actions">
              {% if item.max_attempts %}
                <span class="attempt-task__remaining">{% blocktrans with left=item.remaining_attempts max=item.max_attempts %}Осталось {{ left }} из {{ max }} попыток{% endblocktrans %}</span>
              {% endif %}
              <div class="attempt-task__buttons">
                <button class="btn btn-primary" type="submit" name="is_correct" value="1">{% trans "Отметить как решенную" %}</button>
                <button class="btn btn-secondary" type="submit" name="is_correct" value="0">{% trans "Нужно повторить" %}</button>
              </div>
            </div>
          </form>
        {% endif %}
      {% endif %}
    </article>
  {% empty %}
    <section class="card">
      <p class="hint">{% trans "В шаблоне пока нет задач." %}</p>
    </section>
  {% endfor %}
{% endblock %}

