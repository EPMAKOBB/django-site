{% extends 'accounts/dashboard/base.html' %}
{% load i18n markdown_extras %}

{% block dashboard_title %}{{ assignment.template.name }}{% endblock %}

{% block dashboard_content %}
  <section class="card attempt-work">
    <header class="attempt-work__header">
      <h2 class="attempt-work__title">{{ assignment.template.name }}</h2>
      <div class="attempt-work__meta">
        <div>
          <span class="attempt-work__label">{% trans "Попытка" %}</span>
          <span class="attempt-work__value">#{{ attempt.attempt_number }}</span>
        </div>
        <div>
          <span class="attempt-work__label">{% trans "Прогресс" %}</span>
          <span class="attempt-work__value">
            {% blocktrans with solved=progress_summary.solved_tasks total=progress_summary.total_tasks %}
              {{ solved }} из {{ total }} задач
            {% endblocktrans %}
          </span>
        </div>
        {% if assignment.deadline %}
          <div>
            <span class="attempt-work__label">{% trans "Дедлайн" %}</span>
            <span class="attempt-work__value">{{ assignment.deadline|date:"d E Y H:i" }}</span>
          </div>
        {% endif %}
        {% if time_left %}
          <div>
            <span class="attempt-work__label">{% trans "Осталось времени" %}</span>
            <span class="attempt-work__value">{{ time_left }}</span>
          </div>
        {% endif %}
        <div>
          <span class="attempt-work__label">{% trans "Статус" %}</span>
          {% if attempt_completed %}
            <span class="attempt-work__badge attempt-work__badge--success">{% trans "Завершена" %}</span>
          {% else %}
            <span class="attempt-work__badge attempt-work__badge--active">{% trans "В работе" %}</span>
          {% endif %}
        </div>
      </div>
    </header>

    {% if not attempt_completed %}
      <div class="attempt-work__actions">
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="finalize">
          <button type="submit" class="btn btn-primary">
            {% if all_answers_saved %}
              {% trans "Завершить попытку" %}
            {% else %}
              {% trans "Завершить попытку (даже если остались незаполненные ответы)" %}
            {% endif %}
          </button>
        </form>
      </div>
      {% if not all_answers_saved %}
        <p class="attempt-work__hint">
          {% trans "Сохраните ответы во всех заданиях перед завершением попытки. Вы всегда можете вернуться и изменить ответ до окончания попытки." %}
        </p>
      {% endif %}
    {% else %}
      <p class="attempt-work__hint attempt-work__hint--muted">
        {% trans "Попытка завершена: ниже показаны результаты проверки ответов." %}
      </p>
    {% endif %}
  </section>

  {% for item in tasks %}
    <article class="card attempt-task module-detail__card" id="variant-task-{{ item.variant_task.id }}">
      <header class="attempt-task__header">
        <div class="attempt-task__heading">
          <span class="attempt-task__index">#{{ item.order }}</span>
          <h3 class="attempt-task__title">{{ item.display.title }}</h3>
        </div>
        <div class="attempt-task__badges">
          {% if item.task and item.task.type %}
            <span class="attempt-task__badge">{{ item.task.type.name }}</span>
          {% endif %}
          {% if item.task and item.task.subject %}
            <span class="attempt-task__badge">{{ item.task.subject.name }}</span>
          {% endif %}
          {% if item.task and item.task.difficulty_level %}
            <span class="attempt-task__badge">{% blocktrans with diff=item.task.difficulty_level %}Сложность {{ diff }}{% endblocktrans %}</span>
          {% endif %}
          {% if attempt_completed %}
            {% if item.last_attempt and item.last_attempt.is_correct %}
              <span class="attempt-task__badge attempt-task__badge--success">{% trans "Верно" %}</span>
            {% elif item.last_attempt %}
              <span class="attempt-task__badge attempt-task__badge--danger">{% trans "Ошибка" %}</span>
            {% endif %}
          {% else %}
            {% if item.has_saved_response %}
              <span class="attempt-task__badge attempt-task__badge--active">{% trans "Ответ сохранен" %}</span>
            {% endif %}
          {% endif %}
        </div>
      </header>

      <div class="attempt-task__body module-detail__task">
        <dl class="module-detail__task-meta module-detail__task-meta--top">
          {% if item.task and item.task.type %}
            <div>
              <dt>{% trans "Тип задания" %}</dt>
              <dd>{{ item.task.type.name }}</dd>
            </div>
          {% endif %}
          {% if item.task and item.task.subject %}
            <div>
              <dt>{% trans "Предмет" %}</dt>
              <dd>{{ item.task.subject.name }}</dd>
            </div>
          {% endif %}
        </dl>

        <div class="module-detail__task-panel">
          <div class="module-detail__task-statement">
            {% if item.task_body_html %}
              {% if item.task_rendering_strategy == item.task.RenderingStrategy.MARKDOWN %}
                <div class="module-detail__task-description markdown-content task-content" data-format="markdown">
                  {{ item.task_body_html|safe }}
                </div>
              {% else %}
                <div class="module-detail__task-description task-content" data-format="html">
                  {{ item.task_body_html|safe }}
                </div>
              {% endif %}
            {% elif item.display.description %}
              {% if item.task and item.display.rendering_strategy == item.task.RenderingStrategy.HTML %}
                <div class="module-detail__task-description task-content" data-format="html">
                  {{ item.display.description|render_task_body:item.display.rendering_strategy }}
                </div>
              {% elif item.task and item.display.rendering_strategy == item.task.RenderingStrategy.MARKDOWN %}
                <div class="module-detail__task-description markdown-content task-content" data-format="markdown">
                  {{ item.display.description|render_task_body:item.display.rendering_strategy }}
                </div>
              {% else %}
                <div class="module-detail__task-description task-content" data-format="text">
                  {{ item.display.description|render_task_body:item.display.rendering_strategy }}
                </div>
              {% endif %}
            {% else %}
              <p class="muted">{% trans "Условие задания недоступно." %}</p>
            {% endif %}
            {% if item.display.image %}
              <div class="module-detail__task-image">
                <img src="{{ item.display.image }}" alt="{% trans 'Иллюстрация к заданию' %}">
              </div>
            {% endif %}
          </div>

          {% if not attempt_completed %}
            {% if item.form_available %}
              <form method="post" class="module-detail__task-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="action" value="save-task">
                <input type="hidden" name="variant_task_id" value="{{ item.variant_task.id }}">
                <fieldset class="module-detail__answer-fields">
                  <legend class="sr-only">{{ task_answer_legend }}</legend>
                  {% if item.form.non_field_errors %}
                    <ul class="errorlist">
                      {% for error in item.form.non_field_errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                  {% for field in item.form %}
                    <div class="module-detail__answer-field">
                      {{ field }}
                      {% if field.errors %}
                        <ul class="errorlist">
                          {% for error in field.errors %}
                            <li>{{ error }}</li>
                          {% endfor %}
                        </ul>
                      {% endif %}
                    </div>
                  {% endfor %}
                </fieldset>
                <div class="module-detail__action-buttons module-detail__action-buttons--inline">
                  <button type="submit" class="btn btn--primary">
                    {{ task_answer_submit_label }}
                  </button>
                </div>
              </form>
            {% else %}
              <p class="muted module-detail__task-form-placeholder">{{ task_answer_unavailable_message }}</p>
            {% endif %}

            {% if item.has_saved_response %}
              <p class="attempt-task__hint">
                {% trans "Ответ сохранен." %}
                {% if item.saved_response_updated_at %}
                  {% trans "Обновлено" %} {{ item.saved_response_updated_at|date:"d E Y H:i" }}.
                {% endif %}
                {% if item.saved_response_display %}
                  {% trans "Текущее значение:" %} <span class="attempt-task__hint-value">{{ item.saved_response_display }}</span>
                {% endif %}
              </p>
            {% endif %}
          {% else %}
            {% if item.last_attempt %}
              <div class="attempt-task__hint {% if item.last_attempt.is_correct %}attempt-task__hint--success{% else %}attempt-task__hint--danger{% endif %}">
                <strong>
                  {% if item.last_attempt.is_correct %}
                    {% trans "Ответ верный." %}
                  {% else %}
                    {% trans "Ответ неверный." %}
                  {% endif %}
                </strong>
                {% if item.last_attempt.response_text %}
                  <div>{% trans "Ваш ответ:" %} {{ item.last_attempt.response_text }}</div>
                {% endif %}
                <div>{{ item.last_attempt.created_at|date:"d E Y H:i" }}</div>
              </div>
            {% endif %}
          {% endif %}
        </div>
      </div>

      {% if item.history %}
        <footer class="attempt-task__footer">
          <details class="attempt-task__history">
            <summary>{% trans "История ответов" %}</summary>
            <ul class="attempt-task__history-list">
              {% for history in item.history %}
                <li class="attempt-task__history-item">
                  <span class="attempt-task__history-attempt">#{{ history.number }}</span>
                  <span class="attempt-task__history-status attempt-task__history-status--{% if history.is_correct %}success{% else %}danger{% endif %}">
                    {% if history.is_correct %}{% trans "верно" %}{% else %}{% trans "ошибка" %}{% endif %}
                  </span>
                  <span class="attempt-task__history-date">{{ history.created_at|date:"d E Y H:i" }}</span>
                  {% if history.response_text %}
                    <span class="attempt-task__history-answer">{{ history.response_text }}</span>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          </details>
        </footer>
      {% endif %}
    </article>
  {% empty %}
    <p class="muted">{% trans "В этом варианте пока нет заданий." %}</p>
  {% endfor %}
{% endblock %}
