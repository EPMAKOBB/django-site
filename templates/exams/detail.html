{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ exam.subject.name }} - {{ exam.name }}{% endblock %}
{% block meta_description %}Экзамен {{ exam.subject.name }} — {{ exam.name }}. Персональные задания, аналитика прогресса и подготовка к ЕГЭ и ОГЭ.{% endblock %}
{% block og_title %}{{ exam.subject.name }} — {{ exam.name }} | Фрактал{% endblock %}
{% block og_description %}Экзамен {{ exam.subject.name }} — {{ exam.name }}. Персональные задания, аналитика прогресса и подготовка к ЕГЭ и ОГЭ.{% endblock %}
{% block canonical_url %}{{ request.scheme }}://{{ request.get_host }}{{ request.path }}{% endblock %}
{% block og_url %}{{ request.scheme }}://{{ request.get_host }}{{ request.path }}{% endblock %}
{% block twitter_title %}{{ exam.subject.name }} — {{ exam.name }} | Фрактал{% endblock %}
{% block twitter_description %}Экзамен {{ exam.subject.name }} — {{ exam.name }}. Персональные задания, аналитика прогресса и подготовка к ЕГЭ и ОГЭ.{% endblock %}

{% block content %}
<section class="section">
  <div class="container">
    <h1 class="section-title">{{ exam.subject.name }} - {{ exam.name }}</h1>
  </div>
</section>

<section class="section" id="exam-page"
  data-public-url="{% url 'exam-public-blocks' exam_slug %}"
  data-progress-url="{% url 'exam-progress-data' exam_slug %}"
  data-auth="{{ is_authenticated|yesno:'1,0' }}">
  <div class="container">
    <div id="exam-public-blocks">
      <div class="exam-skeleton exam-card__section">
        <div class="skeleton skeleton-panel"></div>
        <div class="skeleton skeleton-title"></div>
        <div class="skeleton skeleton-row"></div>
        <div class="skeleton skeleton-row"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
        <div class="skeleton skeleton-card"></div>
      </div>
    </div>
  </div>
</section>

<script>
  (function () {
    const pageEl = document.getElementById("exam-page");
    if (!pageEl) return;
    const publicUrl = pageEl.dataset.publicUrl;
    const progressUrl = pageEl.dataset.progressUrl;
    const isAuth = pageEl.dataset.auth === "1";
    const blocksEl = document.getElementById("exam-public-blocks");

    const bindPersonalForm = () => {
      const form = blocksEl.querySelector("[data-exam-personal-form]");
      if (!form) return;
      const auth = form.dataset.auth === "1";
      if (auth) return;
      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const alertEl = blocksEl.querySelector("#exam-auth-alert");
        if (alertEl) {
          alertEl.style.display = "block";
          alertEl.scrollIntoView({ behavior: "smooth", block: "nearest" });
        }
      });
    };

    const applyProgress = (payload) => {
      if (!payload) return;
      const typeProgress = payload.type_progress || {};
      const tagProgress = payload.tag_progress || {};
      Object.keys(typeProgress).forEach((typeId) => {
        const card = blocksEl.querySelector(`[data-type-id="${typeId}"]`);
        if (!card) return;
        const pct = typeProgress[typeId].percent || 0;
        const pctEl = card.querySelector(".type-card__pct-value");
        if (pctEl) pctEl.textContent = `${pct}%`;
        const fillEl = card.querySelector(".progress-bar .fill");
        if (fillEl) fillEl.style.width = `${pct}%`;
        const tags = tagProgress[typeId] || {};
        Object.keys(tags).forEach((tagId) => {
          const chip = card.querySelector(`[data-tag-id="${tagId}"]`);
          if (chip) {
            chip.style.setProperty("--tag-progress", `${tags[tagId]}%`);
          }
        });
      });
    };

    fetch(publicUrl, { credentials: "same-origin" })
      .then((resp) => (resp.ok ? resp.json() : null))
      .then((payload) => {
        if (!payload || !payload.html) return;
        blocksEl.innerHTML = payload.html;
        bindPersonalForm();
        if (!isAuth) return;
        return fetch(progressUrl, { credentials: "same-origin" })
          .then((resp) => (resp.ok ? resp.json() : null))
          .then((progressPayload) => applyProgress(progressPayload));
      })
      .catch(() => {
        blocksEl.innerHTML = '<div class="alert alert-warning">{% trans "Не удалось загрузить данные экзамена." %}</div>';
      });
  })();
</script>
{% endblock %}
