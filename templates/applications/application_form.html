{% extends "base.html" %}

{% block content %}
  <h1>Заявка на обучение</h1>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="source_offer" value="{{ form.initial.source_offer }}">
    {{ form.as_p }}
    <button type="submit">Отправить заявку</button>
    <div id="form-message"></div>
    <p class="application-price">
      <span class="price-old">
        {{ application_price.original }} ₽/мес
      </span>
      <span class="price-new">
        {{ application_price.current }} ₽/мес
      </span>
      <span class="price-note">
        {% if subjects_count >= 2 %}за два предмета {% endif %}
        {% if application_price.promo_until %}
          при записи до {{ application_price.promo_until|date:"j E" }}
        {% endif %}
      </span>
    </p>
  </form>
  <script>
    document.querySelector('form').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const msg = document.getElementById('form-message');
        const resp = await fetch(form.action || window.location.href, {
            method: 'POST',
            headers: {'X-Requested-With': 'XMLHttpRequest'},
            body: new FormData(form),
        });
        if (resp.ok) {
            const data = await resp.json();
            msg.textContent = data.message;
            form.reset();
        } else {
            msg.textContent = 'Не удалось отправить.';
        }
    });
  </script>
{% endblock %}
