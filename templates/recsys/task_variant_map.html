{% extends "base.html" %}

{% block title %}Карта вариантов{% endblock %}
{% block meta_robots %}noindex,nofollow{% endblock %}

{% block content %}
<style>
  .variant-map-page {
    width: 100%;
    max-width: 100%;
    padding: 14px 18px 24px;
    box-sizing: border-box;
    color: #e5e7eb;
  }
  .variant-map-card {
    background: #0f172a;
    border: 1px solid #1f2937;
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 12px;
  }
  .variant-map-filters {
    display: grid;
    grid-template-columns: repeat(3, minmax(200px, 1fr));
    gap: 10px;
    align-items: end;
  }
  .variant-map-field label {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 4px;
    color: #93c5fd;
  }
  .variant-map-field select {
    width: 100%;
    background: #0b1224;
    color: #e5e7eb;
    border: 1px solid #334155;
    border-radius: 6px;
    padding: 8px;
  }
  .variant-map-btn {
    background: #1d4ed8;
    color: #fff;
    border: 0;
    border-radius: 6px;
    padding: 8px 12px;
    cursor: pointer;
    font-weight: 600;
  }
  .variant-map-source-title {
    margin: 0 0 8px;
    color: #93c5fd;
    font-size: 1rem;
  }
  .variant-map-table-wrap {
    overflow-x: auto;
  }
  .variant-map-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    min-width: 980px;
  }
  .variant-map-table th,
  .variant-map-table td {
    border: 1px solid #1f2937;
    padding: 6px;
    vertical-align: top;
  }
  .variant-map-table th {
    background: #111827;
    color: #cbd5e1;
    font-size: 0.85rem;
    text-align: left;
  }
  .variant-map-table .row-title {
    width: 230px;
    font-weight: 600;
    color: #93c5fd;
    background: #0b1224;
  }
  .task-cell-link {
    display: block;
    text-decoration: none;
    border-radius: 6px;
    padding: 8px;
    border: 1px solid #334155;
    font-size: 0.86rem;
    line-height: 1.3;
    min-height: 42px;
  }
  .task-cell-link.filled {
    background: #065f46;
    border-color: #10b981;
    color: #ecfeff;
  }
  .task-cell-link.empty {
    background: #1e293b;
    border-style: dashed;
    color: #cbd5e1;
  }
  .task-cell-meta {
    display: block;
    margin-top: 4px;
    opacity: 0.9;
    font-size: 0.78rem;
  }
  .muted-line {
    color: #94a3b8;
    font-size: 0.9rem;
    margin: 0 0 10px;
  }
</style>

<div class="variant-map-page">
  <div class="variant-map-card">
    <h2 style="margin: 0 0 10px;">Карта вариантов</h2>
    <form method="get" class="variant-map-filters">
      <div class="variant-map-field">
        <label for="subject-filter">Предмет</label>
        <select id="subject-filter" name="subject">
          <option value="">-</option>
          {% for subject in subjects %}
            <option value="{{ subject.id }}" {% if selected_subject_id == subject.id %}selected{% endif %}>
              {{ subject.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="variant-map-field">
        <label for="exam-filter">Версия экзамена</label>
        <select id="exam-filter" name="exam_version">
          <option value="">-</option>
          {% for exam in exam_versions %}
            <option value="{{ exam.id }}" {% if selected_exam_version_id == exam.id %}selected{% endif %}>
              {{ exam.subject__name }} · {{ exam.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="variant-map-field">
        <button type="submit" class="variant-map-btn">Открыть карту</button>
      </div>
    </form>
  </div>

  {% if selected_exam and task_types %}
    <p class="muted-line">
      Экзамен: <strong>{{ selected_exam.subject.name }} · {{ selected_exam.name }}</strong>.
      В каждой ячейке: заполнено (редактировать) или пусто (создать с предзаполнением).
    </p>

    {% for section in source_sections %}
      <div class="variant-map-card">
        <h3 class="variant-map-source-title">{{ section.source.name }}</h3>
        <div class="variant-map-table-wrap">
          <table class="variant-map-table">
            <thead>
              <tr>
                <th class="row-title">Вариант в источнике</th>
                {% for task_type in task_types %}
                  <th>{{ task_type.name }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in section.rows %}
                <tr>
                  <td class="row-title">
                    {{ row.title }}
                    <div class="task-cell-meta">Заполнено: {{ row.filled_count }}/{{ task_types|length }}</div>
                  </td>
                  {% for cell in row.cells %}
                    <td>
                      {% if cell.is_filled %}
                        <a class="task-cell-link filled" href="{{ cell.url }}">
                          {{ cell.task.title|default:cell.task.slug }}
                          <span class="task-cell-meta">#{{ cell.task.id }} · {{ cell.task.slug }}</span>
                          {% if cell.extra_count %}
                            <span class="task-cell-meta">+{{ cell.extra_count }} дубль(ей)</span>
                          {% endif %}
                        </a>
                      {% else %}
                        <a class="task-cell-link empty" href="{{ cell.url }}">
                          {{ cell.task_type.name }}
                          <span class="task-cell-meta">Создать задачу</span>
                        </a>
                      {% endif %}
                    </td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endfor %}

    {% if no_source_row %}
      <div class="variant-map-card">
        <h3 class="variant-map-source-title">Без источника</h3>
        <div class="variant-map-table-wrap">
          <table class="variant-map-table">
            <thead>
              <tr>
                <th class="row-title">Группа</th>
                {% for task_type in task_types %}
                  <th>{{ task_type.name }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="row-title">
                  {{ no_source_row.title }}
                  <div class="task-cell-meta">Заполнено: {{ no_source_row.filled_count }}/{{ task_types|length }}</div>
                </td>
                {% for cell in no_source_row.cells %}
                  <td>
                    {% if cell.is_filled %}
                      <a class="task-cell-link filled" href="{{ cell.url }}">
                        {{ cell.task.title|default:cell.task.slug }}
                        <span class="task-cell-meta">#{{ cell.task.id }} · {{ cell.task.slug }}</span>
                        {% if cell.extra_count %}
                          <span class="task-cell-meta">+{{ cell.extra_count }} дубль(ей)</span>
                        {% endif %}
                      </a>
                    {% else %}
                      <a class="task-cell-link empty" href="{{ cell.url }}">
                        {{ cell.task_type.name }}
                        <span class="task-cell-meta">Создать задачу</span>
                      </a>
                    {% endif %}
                  </td>
                {% endfor %}
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}
  {% elif selected_exam_version_id and selected_subject_id %}
    <div class="variant-map-card">
      <p class="muted-line" style="margin:0;">Для выбранной пары предмет+экзамен не найдено типов задач.</p>
    </div>
  {% else %}
    <div class="variant-map-card">
      <p class="muted-line" style="margin:0;">Выберите предмет и экзамен, затем откройте карту.</p>
    </div>
  {% endif %}
</div>
{% endblock %}
