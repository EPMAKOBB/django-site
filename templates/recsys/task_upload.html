{% extends "base.html" %}

{% block title %}Загрузка задачи{% endblock %}

{% block content %}
<style>
  :root {
    --panel-bg: #0f172a;
    --panel-border: #1f2937;
    --panel-accent: #2563eb;
    --text-main: #e5e7eb;
    --text-muted: #9ca3af;
    --input-bg: #111827;
    --input-border: #1f2937;
    --input-focus: #2563eb;
    --error: #f87171;
  }
  .upload-wrapper {
    max-width: 1100px;
    margin: 2rem auto 3rem;
    padding: 0 1rem;
    color: var(--text-main);
  }
  .upload-card {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  .upload-header h2 {
    margin: 0 0 0.25rem;
    letter-spacing: 0.5px;
  }
  .upload-header p {
    margin: 0 0 1rem;
    color: var(--text-muted);
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
  }
  .form-field label {
    display: block;
    margin-bottom: 6px;
    font-size: 0.95rem;
    color: var(--text-main);
  }
  .form-field input,
  .form-field select,
  .form-field textarea {
    width: 100%;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    color: var(--text-main);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 0.95rem;
    box-shadow: inset 0 1px 2px rgba(0,0,0,0.35);
  }
  .form-field input:focus,
  .form-field select:focus,
  .form-field textarea:focus {
    outline: 1px solid var(--input-focus);
    border-color: var(--input-focus);
  }
  .hint {
    color: var(--text-muted);
    margin-top: -4px;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }
  .files-block {
    margin-top: 10px;
    padding: 12px;
    border: 1px solid var(--panel-border);
    border-radius: 10px;
    background: #0b1224;
  }
  .files-block p {
    margin: 0 0 10px;
    color: var(--text-main);
  }
  .btn-primary {
    background: var(--panel-accent);
    color: white;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.08s ease, box-shadow 0.2s ease;
  }
  .btn-primary:hover {
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
    transform: translateY(-1px);
  }
  .alert-danger {
    border: 1px solid var(--error);
    background: rgba(248,113,113,0.08);
    color: #fecaca;
    padding: 10px 12px;
    border-radius: 8px;
    margin-bottom: 12px;
  }
  select[multiple] {
    min-height: 140px;
  }
  .inline-note {
    display: block;
    margin-top: 6px;
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  .skill-suggestions {
    margin-top: 10px;
    padding: 10px 12px;
    background: #0c1326;
    border: 1px solid var(--panel-border);
    border-radius: 10px;
  }
  .suggestion-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    font-weight: 600;
  }
  .pill-button {
    background: transparent;
    color: var(--text-main);
    border: 1px solid var(--panel-border);
    border-radius: 999px;
    padding: 6px 12px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s ease, border-color 0.2s ease;
  }
  .pill-button:hover {
    background: rgba(37, 99, 235, 0.1);
    border-color: var(--panel-accent);
  }
  .pill-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .suggestions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 10px;
  }
  .suggestion-chip {
    border: 1px solid var(--panel-border);
    border-radius: 10px;
    padding: 6px 10px;
    background: #0e1528;
    color: var(--text-main);
    cursor: pointer;
    font-size: 0.9rem;
    transition: border-color 0.2s ease, transform 0.08s ease;
  }
  .suggestion-chip:hover {
    border-color: var(--panel-accent);
    transform: translateY(-1px);
  }
  .muted {
    color: var(--text-muted);
  }
  .errorlist, .errorlist li, .form-field .errorlist {
    color: #f87171;
    margin: 4px 0;
    list-style: none;
    padding: 0;
    font-size: 0.9rem;
  }
  .alert-danger {
    border-color: #f87171;
    color: #fecaca;
  }
  .answer-grid {
    display: grid;
    gap: 10px;
  }
  .answer-row {
    display: grid;
    gap: 8px;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  }
  .answer-cell label {
    display: block;
    margin-bottom: 4px;
    color: var(--text-muted);
    font-size: 0.9rem;
  }
  .answer-input {
    width: 100%;
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    color: var(--text-main);
    border-radius: 8px;
    padding: 8px 10px;
  }
</style>

<div class="upload-wrapper">
  <div class="upload-header">
    <h2>Загрузка задачи</h2>
    <p>Подсказка: slug в формате <code>17-01-krylov</code>, а пути к файлам и картинкам строятся по этому slug.</p>
  </div>

  <div class="upload-card">
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert-danger">{{ form.non_field_errors }}</div>
      {% endif %}

      <div class="form-grid">
        <div class="form-field">
          <label for="{{ form.subject.id_for_label }}">Предмет</label>
          {{ form.subject }}{{ form.subject.errors }}
        </div>
        <div class="form-field">
          <label for="{{ form.exam_version.id_for_label }}">Версия экзамена</label>
          {{ form.exam_version }}{{ form.exam_version.errors }}
        </div>
        <div class="form-field">
          <label for="{{ form.type.id_for_label }}">Тип задачи</label>
          {{ form.type }}{{ form.type.errors }}
        </div>
      </div>

      <div class="form-grid" style="margin-top: 10px;">
        <div class="form-field">
          <label for="{{ form.slug.id_for_label }}">Slug</label>
          {{ form.slug }}{{ form.slug.errors }}
          <div class="hint">Например: 17-01-krylov</div>
        </div>
        <div class="form-field">
          <label for="{{ form.title.id_for_label }}">Заголовок</label>
          {{ form.title }}{{ form.title.errors }}
        </div>
      </div>

      <div class="form-grid" style="margin-top: 10px;">
        <div class="form-field">
          <label for="{{ form.source.id_for_label }}">Источник</label>
          {{ form.source }}{{ form.source.errors }}
          <div class="hint">Например: КИМ, учебник, авторская подборка.</div>
        </div>
        <div class="form-field">
          <label for="{{ form.source_variant.id_for_label }}">Вариант в источнике</label>
          {{ form.source_variant }}{{ form.source_variant.errors }}
          <div class="hint">Например: 13.12.2025 или № 19.</div>
        </div>
      </div>

      <div class="form-field" style="margin-top: 10px;">
        <label for="{{ form.description.id_for_label }}">Описание</label>
        {{ form.description }}{{ form.description.errors }}
      </div>

      <div class="form-field" style="margin-top: 10px;">
        <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
          <label for="{{ form.correct_answer.id_for_label }}" style="margin:0;">Правильный ответ</label>
          <button type="button" class="pill-button" id="toggle-answer-builder">Показать поля ответа</button>
          <span id="answer-schema-title" class="inline-note"></span>
        </div>
        {{ form.answer_inputs }}
        <div id="answer-builder" class="files-block" style="display:none; margin-top:10px;">
          <div id="answer-fields"></div>
          <div class="hint" id="answer-builder-hint"></div>
        </div>
        {{ form.correct_answer }}{{ form.correct_answer.errors }}
        <span class="inline-note">JSON структура ответа, например {"value": 42}. При наличии схемы ответ можно ввести через поля выше.</span>
      </div>

      <div class="form-grid" style="margin-top: 10px;">
        <div class="form-field">
          <label for="{{ form.rendering_strategy.id_for_label }}">Режим рендера</label>
          {{ form.rendering_strategy }}{{ form.rendering_strategy.errors }}
        </div>
        <div class="form-field">
          <label for="{{ form.difficulty_level.id_for_label }}">Сложность</label>
          {{ form.difficulty_level }}{{ form.difficulty_level.errors }}
        </div>
      </div>

      <div class="form-grid" style="margin-top: 10px;">
        <div class="form-field">
          <label for="{{ form.tags.id_for_label }}">Обязательные теги типа</label>
          {{ form.tags }}{{ form.tags.errors }}
          <span class="inline-note" id="tags-helper">Список подстраивается под выбранный тип задачи.</span>
        </div>
        <div class="form-field">
          <label for="{{ form.skills.id_for_label }}">Навыки задачи</label>
          {{ form.skills }}{{ form.skills.errors }}
          <span class="inline-note">Фильтруются по предмету. Вес каждого выбранного навыка = 1.0.</span>
          <div class="skill-suggestions">
            <div class="suggestion-header">
              <span>Подсказки по навыкам</span>
              <button type="button" class="pill-button" id="fetch-skill-suggestions">Предложить</button>
            </div>
            <div id="skill-suggestions-list" class="suggestions-list"></div>
          </div>
        </div>
      </div>

      <div class="files-block">
        <p><strong>Прикрепления</strong> (для задачи 27 используйте A/B; для других задач - любые метки):</p>
        <div class="form-grid">
          <div class="form-field">
            <label for="{{ form.file_a.id_for_label }}">Файл A</label>
            {{ form.file_a }}{{ form.file_a.errors }}
          </div>
          <div class="form-field">
            <label for="{{ form.file_b.id_for_label }}">Файл B</label>
            {{ form.file_b }}{{ form.file_b.errors }}
          </div>
          <div class="form-field">
            <label for="{{ form.image.id_for_label }}">Картинка (опционально)</label>
            {{ form.image }}{{ form.image.errors }}
          </div>
        </div>
        <div class="hint" id="preview-urls">
          <div>Используйте токены в описании: ![[att:img]] для картинки, ![[att:a]] и ![[att:b]] для файлов. После сохранения они превратятся в ссылки.</div>
        </div>
      </div>

      <div style="margin-top: 16px;">
        <button type="submit" class="btn-primary">Сохранить</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function() {
    const map = {
      "а": "a", "б": "b", "в": "v", "г": "g", "д": "d", "е": "e", "ё": "e", "ж": "zh",
      "з": "z", "и": "i", "й": "j", "к": "k", "л": "l", "м": "m", "н": "n", "о": "o",
      "п": "p", "р": "r", "с": "s", "т": "t", "у": "u", "ф": "f", "х": "h", "ц": "c",
      "ч": "ch", "ш": "sh", "щ": "sch", "ы": "y", "э": "e", "ю": "yu", "я": "ya",
      "ъ": "", "ь": ""
    };
    function slugify(text) {
      return (text || "")
        .toString()
        .trim()
        .toLowerCase()
        .split("")
        .map(ch => map[ch] !== undefined ? map[ch] : ch)
        .join("")
        .replace(/[^a-z0-9\\-\\s_]+/g, "")
        .replace(/[\\s_]+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "");
    }

    const title = document.getElementById("id_title");
    const slug = document.getElementById("id_slug");
    const typeSel = document.getElementById("id_type");
    const sourceSel = document.getElementById("id_source");
    const variantSel = document.getElementById("id_source_variant");
    const examSel = document.getElementById("id_exam_version");
    const preview = document.getElementById("preview-urls");

    let lastAutoTitle = "";
    let lastAutoSlug = "";

    function extractTypeNumber(text) {
      const m = /тип\\s*([0-9]+)/i.exec(text || "");
      return m ? m[1] : "";
    }

    function suggestTitle(force = false) {
      if (!title || !typeSel || !sourceSel || !variantSel) return;
      const current = title.value.trim();
      const untouched = !current || current === lastAutoTitle;
      if (!untouched && !force) return;

      const tText = typeSel.options[typeSel.selectedIndex]?.text || "";
      const tNum = extractTypeNumber(tText);
      const vText = variantSel.options[variantSel.selectedIndex]?.text || "";

      const parts = [];
      if (tNum) parts.push(tNum);
      if (vText) parts.push(vText);
      const suggestion = parts.join(" ");
      title.value = suggestion;
      lastAutoTitle = suggestion;
      suggestSlug(true);
    }

    function suggestSlug(force = false) {
      if (!slug) return;
      const typeText = typeSel?.options[typeSel.selectedIndex]?.text || "";
      const typeNum = extractTypeNumber(typeText) || (typeSel?.value || "");
      const currentValue = slug.value.trim();
      const baseText = title?.value || "";
      const untouched = !currentValue || currentValue === lastAutoSlug;
      if (!untouched && !force) {
        updatePreview();
        return;
      }
      const parts = [];
      if (typeNum) parts.push(typeNum);
      const baseSlug = slugify(baseText || currentValue || "");
      if (baseSlug) parts.push(baseSlug);
      const newSlug = parts.join("-");
      slug.value = newSlug;
      lastAutoSlug = newSlug;
      updatePreview();
    }

    function getExt(input, fallback = "") {
      const val = input?.value || "";
      const dot = val.lastIndexOf(".");
      if (dot === -1) return fallback;
      return val.slice(dot);
    }

    function updatePreview() {
      if (!preview || !examSel || !slug) return;
      const examText = examSel.options[examSel.selectedIndex]?.text || "";
      const examSlug = slugify(examText) || "exam";
      const taskSlug = slug.value.trim() || "task";
      const imgExt = getExt(document.getElementById("id_image"), ".png");
      const fileAExt = getExt(document.getElementById("id_file_a"), "");
      const fileBExt = getExt(document.getElementById("id_file_b"), "");
      const lines = [];
      lines.push(`Картинка: ![[att:img]] -> tasks/${examSlug}/images/${taskSlug}${imgExt}`);
      lines.push(`Файл A: ![[att:a]] -> tasks/${examSlug}/files/${taskSlug}-a${fileAExt || "<ext>"}`);
      lines.push(`Файл B: ![[att:b]] -> tasks/${examSlug}/files/${taskSlug}-b${fileBExt || "<ext>"}`);
      lines.push("Токены будут заменены на ссылки после сохранения.");
      preview.innerHTML = lines.map(t => `<div>${t}</div>`).join("");
    }

    ["change","input"].forEach(evt => {
      if (title) title.addEventListener(evt, () => suggestSlug(false));
      if (slug) slug.addEventListener(evt, updatePreview);
      if (typeSel) typeSel.addEventListener(evt, () => suggestTitle(true));
      if (sourceSel) sourceSel.addEventListener(evt, () => suggestTitle(true));
      if (variantSel) variantSel.addEventListener(evt, () => suggestTitle(true));
      if (examSel) examSel.addEventListener(evt, updatePreview);
    });

    ["id_image", "id_file_a", "id_file_b"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener("change", updatePreview);
    });

    suggestTitle(true);
    suggestSlug(true);
    updatePreview();
  })();
</script>
<script>
  const EXAM_VERSIONS = JSON.parse('{{ exam_versions_json|escapejs }}');
  const TASK_TYPES = JSON.parse('{{ task_types_json|escapejs }}');
  const REQUIRED_TAGS = JSON.parse('{{ required_tags_json|escapejs }}');
  const SKILLS = JSON.parse('{{ skills_json|escapejs }}');
  const SKILL_SUGGESTIONS = JSON.parse('{{ skill_suggestions_json|escapejs }}');
  const ANSWER_SCHEMAS = JSON.parse('{{ answer_schemas_json|escapejs }}');

  (function () {
    const subjectSel = document.getElementById("id_subject");
    const examSel = document.getElementById("id_exam_version");
    const typeSel = document.getElementById("id_type");

    function populate(select, items, currentValue) {
      if (!select) return;
      const prev = currentValue || select.value;
      select.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "-";
      select.appendChild(placeholder);
      items.forEach((item) => {
        const opt = document.createElement("option");
        opt.value = String(item.id);
        opt.textContent = item.name;
        if (String(item.id) === String(prev)) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function filterExamVersions() {
      if (!examSel) return;
      const subj = subjectSel ? subjectSel.value : "";
      const filtered = subj
        ? EXAM_VERSIONS.filter((v) => String(v.subject_id) === String(subj))
        : EXAM_VERSIONS;
      populate(examSel, filtered, examSel.value);
    }

    function filterTaskTypes() {
      if (!typeSel) return;
      const subj = subjectSel ? subjectSel.value : "";
      const exam = examSel ? examSel.value : "";
      let filtered = TASK_TYPES;
      if (exam) {
        filtered = filtered.filter((t) => String(t.exam_version_id) === String(exam));
      } else if (subj) {
        filtered = filtered.filter((t) => String(t.subject_id) === String(subj));
      }
      populate(typeSel, filtered, typeSel.value);
      if (typeSel) {
        typeSel.dispatchEvent(new Event("change"));
      }
    }

    if (subjectSel) {
      subjectSel.addEventListener("change", () => {
        filterExamVersions();
        filterTaskTypes();
      });
    }
    if (examSel) {
      examSel.addEventListener("change", filterTaskTypes);
    }

    filterExamVersions();
    filterTaskTypes();
  })();
</script>
<script>
  (function() {
    const subjectSel = document.getElementById("id_subject");
    const typeSel = document.getElementById("id_type");
    const tagsSelect = document.getElementById("id_tags");
    const skillsSelect = document.getElementById("id_skills");
    const suggestionsList = document.getElementById("skill-suggestions-list");
    const suggestBtn = document.getElementById("fetch-skill-suggestions");
    const tagsHelper = document.getElementById("tags-helper");

    function updateTagOptions() {
      if (!tagsSelect) return;
      const typeId = typeSel ? typeSel.value : "";
      const tags = (typeId && REQUIRED_TAGS[typeId]) || [];
      const selected = new Set(Array.from(tagsSelect.options).filter((o) => o.selected).map((o) => o.value));
      tagsSelect.innerHTML = "";

      if (!tags.length) {
        tagsSelect.disabled = true;
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = typeId ? "Для типа нет обязательных тегов" : "Выберите тип задачи";
        tagsSelect.appendChild(opt);
        if (tagsHelper) tagsHelper.textContent = opt.textContent;
        return;
      }

      tagsSelect.disabled = false;
      tags.forEach((tag) => {
        const opt = document.createElement("option");
        opt.value = String(tag.id);
        opt.textContent = tag.name;
        if (selected.has(String(tag.id))) opt.selected = true;
        tagsSelect.appendChild(opt);
      });
      if (tagsHelper) tagsHelper.textContent = "Выберите теги из обязательного списка типа.";
    }

    function updateSkillOptions() {
      if (!skillsSelect) return;
      const subj = subjectSel ? subjectSel.value : "";
      const selected = new Set(Array.from(skillsSelect.options).filter((o) => o.selected).map((o) => o.value));
      const filtered = subj ? SKILLS.filter((s) => String(s.subject_id) === String(subj)) : SKILLS;
      skillsSelect.innerHTML = "";

      if (!filtered.length) {
        skillsSelect.disabled = true;
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = subj ? "Навыки не найдены" : "Сначала выберите предмет";
        skillsSelect.appendChild(opt);
        return;
      }

      skillsSelect.disabled = false;
      filtered.forEach((skill) => {
        const opt = document.createElement("option");
        opt.value = String(skill.id);
        opt.textContent = skill.name;
        if (selected.has(String(skill.id))) opt.selected = true;
        skillsSelect.appendChild(opt);
      });
    }

    function ensureSkillOption(skillId, name) {
      if (!skillsSelect) return null;
      let option = Array.from(skillsSelect.options).find((o) => String(o.value) === String(skillId));
      if (!option) {
        option = document.createElement("option");
        option.value = String(skillId);
        option.textContent = name || `Навык ${skillId}`;
        option.selected = true;
        skillsSelect.appendChild(option);
      }
      return option;
    }

    function renderSkillSuggestions() {
      if (!suggestionsList) return;
      const typeId = typeSel ? typeSel.value : "";
      suggestionsList.innerHTML = "";

      if (!typeId) {
        suggestionsList.innerHTML = '<span class="muted">Сначала выберите тип задачи.</span>';
        return;
      }

      const suggestions = SKILL_SUGGESTIONS[typeId] || [];
      if (!suggestions.length) {
        suggestionsList.innerHTML = '<span class="muted">Пока нет задач этого типа с навыками.</span>';
        return;
      }

      suggestions.forEach((entry) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "suggestion-chip";
        btn.textContent = `${entry.name} · ${entry.usage}`;
        btn.title = `Используется в ${entry.usage} задаче(ах) этого типа`;
        btn.addEventListener("click", () => {
          const option = ensureSkillOption(entry.id, entry.name);
          if (option) option.selected = !option.selected;
        });
        suggestionsList.appendChild(btn);
      });
    }

    if (subjectSel) subjectSel.addEventListener("change", () => { updateSkillOptions(); updateTagOptions(); });
    if (typeSel) typeSel.addEventListener("change", () => { updateTagOptions(); renderSkillSuggestions(); });
    if (suggestBtn) suggestBtn.addEventListener("click", renderSkillSuggestions);

    updateSkillOptions();
    updateTagOptions();
    renderSkillSuggestions();
  })();
</script>
<script>
  (function() {
    const typeSel = document.getElementById("id_type");
    const toggleBtn = document.getElementById("toggle-answer-builder");
    const builder = document.getElementById("answer-builder");
    const fields = document.getElementById("answer-fields");
    const builderHint = document.getElementById("answer-builder-hint");
    const schemaTitle = document.getElementById("answer-schema-title");
    const hiddenAnswer = document.getElementById("id_answer_inputs");
    const correctAnswer = document.getElementById("id_correct_answer");
    const form = document.querySelector("form");

    function currentSchema() {
      const typeId = typeSel ? typeSel.value : "";
      if (!typeId) return null;
      return ANSWER_SCHEMAS[String(typeId)] || null;
    }

    function resetBuilderState() {
      if (fields) fields.innerHTML = "";
      if (builder) builder.style.display = "none";
      if (schemaTitle) schemaTitle.textContent = "";
      if (toggleBtn) toggleBtn.textContent = "Показать поля ответа";
      if (hiddenAnswer) hiddenAnswer.value = "";
    }

    function buildInputs(schema) {
      if (!fields || !schema) return;
      fields.innerHTML = "";
      const cfg = schema.config || {};
      const rows = Number(cfg.rows || 1);
      const cols = Number(cfg.cols || 1);
      const inputType = cfg.input_type || "string";
      const perCellMax = cfg.per_cell_max_length ? Number(cfg.per_cell_max_length) : null;
      const allowBlankRows = !!cfg.allow_blank_rows;

      const container = document.createElement("div");
      container.className = "answer-grid";

      for (let r = 0; r < rows; r++) {
        const rowEl = document.createElement("div");
        rowEl.className = "answer-row";
        for (let c = 0; c < cols; c++) {
          const wrap = document.createElement("div");
          wrap.className = "answer-cell";
          const label = document.createElement("label");
          label.textContent = rows > 1 ? `Строка ${r + 1}, поле ${c + 1}` : `Поле ${c + 1}`;
          const input = document.createElement("input");
          input.name = `answer_r${r}_c${c}`;
          input.dataset.row = String(r);
          input.dataset.col = String(c);
          input.className = "answer-input";
          if (inputType === "uint" || inputType === "int" || inputType === "float") {
            input.type = "number";
            if (inputType === "uint") input.min = "0";
            if (inputType === "float") input.step = "any";
          } else {
            input.type = "text";
          }
          if (perCellMax) input.maxLength = perCellMax;
          wrap.appendChild(label);
          wrap.appendChild(input);
          rowEl.appendChild(wrap);
        }
        container.appendChild(rowEl);
      }

      fields.appendChild(container);
      if (builderHint) {
        const hints = [];
        hints.push(`Схема: ${rows}×${cols}, тип: ${inputType}`);
        if (perCellMax) hints.push(`Лимит символов в клетке: ${perCellMax}`);
        if (allowBlankRows) hints.push("Пустые строки можно оставить незаполненными.");
        builderHint.textContent = hints.join(" · ");
      }

      setupAutoAdvance(cfg);
      syncAnswerPayload();
      Array.from(fields.querySelectorAll("input")).forEach((input) => {
        input.addEventListener("input", syncAnswerPayload);
      });
    }

    function setupAutoAdvance(cfg) {
      const rows = Number(cfg.rows || 1);
      const cols = Number(cfg.cols || 1);
      const perCellMax = cfg.per_cell_max_length ? Number(cfg.per_cell_max_length) : null;
      if (!(rows === 1 && cols > 1 && perCellMax === 1)) return;
      const inputs = Array.from(fields.querySelectorAll("input.answer-input"));
      inputs.forEach((input, idx) => {
        input.addEventListener("input", (e) => {
          const val = e.target.value || "";
          if (val.length >= 1 && idx < inputs.length - 1) {
            inputs[idx + 1].focus();
            inputs[idx + 1].select();
          }
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !e.target.value && idx > 0) {
            inputs[idx - 1].focus();
          }
        });
      });
    }

    function collectPayload() {
      const schema = currentSchema();
      if (!schema || !fields) return null;
      const cfg = schema.config || {};
      const rows = Number(cfg.rows || 1);
      const cols = Number(cfg.cols || 1);
      const allowBlankRows = !!cfg.allow_blank_rows;
      const perCellMax = cfg.per_cell_max_length ? Number(cfg.per_cell_max_length) : null;
      const inputType = cfg.input_type || "string";

      const fetchCell = (r, c) => {
        const input = fields.querySelector(`input[data-row="${r}"][data-col="${c}"]`);
        return input ? input.value : "";
      };

      if (rows === 1 && cols === 1) {
        return fetchCell(0, 0);
      }

      if (rows === 1) {
        return Array.from({ length: cols }, (_, c) => fetchCell(0, c));
      }

      const matrix = [];
      for (let r = 0; r < rows; r++) {
        const rowVals = Array.from({ length: cols }, (_, c) => fetchCell(r, c));
        if (allowBlankRows && rowVals.every((v) => v === "")) {
          matrix.push([]);
        } else {
          matrix.push(rowVals);
        }
      }

      if (allowBlankRows) {
        while (matrix.length && (matrix[matrix.length - 1].length === 0 || matrix[matrix.length - 1].every((v) => v === ""))) {
          matrix.pop();
        }
      }
      return matrix;
    }

    function syncAnswerPayload() {
      const schema = currentSchema();
      if (!schema) return;
      const payload = collectPayload();
      if (payload === null || payload === undefined) return;
      const serialised = JSON.stringify(payload);
      if (hiddenAnswer) hiddenAnswer.value = serialised;
      if (correctAnswer) {
        correctAnswer.value = serialised;
      }
    }

    function maybeEnableBuilder() {
      const schema = currentSchema();
      if (!toggleBtn) return;
      if (!schema) {
        toggleBtn.disabled = true;
        resetBuilderState();
        return;
      }
      toggleBtn.disabled = false;
      if (schemaTitle) schemaTitle.textContent = `Схема: ${schema.name}`;
    }

    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        const schema = currentSchema();
        if (!schema) return;
        const isOpen = builder && builder.style.display === "block";
        if (builder) builder.style.display = isOpen ? "none" : "block";
        toggleBtn.textContent = isOpen ? "Показать поля ответа" : "Скрыть поля ответа";
        if (!isOpen) {
          buildInputs(schema);
        }
      });
    }

    if (typeSel) {
      typeSel.addEventListener("change", () => {
        resetBuilderState();
        maybeEnableBuilder();
      });
    }

    if (form) {
      form.addEventListener("submit", () => {
        const schema = currentSchema();
        if (schema && builder && builder.style.display === "block") {
          syncAnswerPayload();
        }
      });
    }

    maybeEnableBuilder();
  })();
</script>
{% endblock %}
